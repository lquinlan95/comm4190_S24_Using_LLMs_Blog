<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Leesa">
<meta name="dcterms.date" content="2024-02-14">
<meta name="description" content="What happens when we try to get a little romance out of ChatGPT?">

<title>RoboTalk - Storybook Struggles (Part I)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">RoboTalk</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Storybook Struggles (Part I)</h1>
                  <div>
        <div class="description">
          What happens when we try to get a little romance out of ChatGPT?
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">LLMs</div>
                <div class="quarto-category">prompting</div>
                <div class="quarto-category">text generation</div>
                <div class="quarto-category">text analysis</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Leesa </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 14, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="storybook-struggles-part-i" class="level2">
<h2 class="anchored" data-anchor-id="storybook-struggles-part-i">Storybook Struggles (Part I)</h2>
<p>It’s Valentine’s Day, and I thought it would be great to have ChatGPT help me spread a little bit of love in the world. So, I asked it to write me a love story… <em>but with a twist!</em></p>
<p>Below I’ve chronicled the twists and turns of my attempts to get ChatGPT to write me a story suitable for the holiday.</p>
<section id="writing-the-initial-story" class="level3">
<h3 class="anchored" data-anchor-id="writing-the-initial-story">Writing the initial story</h3>
<p>The first thing to do was to get ChatGPT to write me a love story that truly reflected my - and many others’ - feelings about Valentine’s Day!</p>
<p>The prompt I used was:</p>
<blockquote class="blockquote">
<p><em>Hello! You are an aspiring author. To this point, you have only written horror novels. You love scary things. You love to instill fear in others. You love monsters, and blood, and ghosts, and death. Now you are tasked with writing a love story for Valentine’s Day. It should be around 100 words.</em></p>
</blockquote>
<p>Honestly, the story ChatGPT gave was pretty spot on impressive:</p>
<blockquote class="blockquote">
<p><em>In the shadow of an ancient, twisted oak, beneath a moonlit sky, two souls entwined by fate’s cruel hand found sanctuary. Evan, haunted by whispers of the past, and Lila, a beacon of light in his darkened world, discovered solace in each other’s arms. Amid the encroaching gloom, their love was a rebellious flame, defying the darkness. Their kisses, soft as the murmur of ghostly winds, spoke of a love as enduring as the stars. As the night whispered secrets of the undead, their hearts beat in unison, a testament to love’s power over death. In this eerie embrace, they found their forever, a love story not even the specters could tarnish.</em></p>
</blockquote>
<p>The piece seemed to incorporate most of the aspects from the prompt. The story had a rather dark, horror-esque theme, but still incorporated a love story suitable for Valentine’s Day. I even asked ChatGPT to do a word count to see if it had followed my instructions regarding the piece’s length:</p>
<blockquote class="blockquote">
<p><em>How many words is that?</em></p>
</blockquote>
<p>I kept the prompt rather simple to determine if ChatGPT would be able to understand exactly what I was asking - namely, please count the number of the words in your response - and it performed admirably, providing not only the number of words…</p>
<blockquote class="blockquote">
<p><em>The story contains 112 words</em></p>
</blockquote>
<p>… but also the code used to calculate it…</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="body2_files/figure-html/e9d7e97a-f92e-411d-8c62-1608d7820af7-1-f7beabf9-ba67-4d5b-9f4a-a89701272f3b.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<p>Not exactly right, but I figured, good enough… <em>for now!</em>count g)</p>
</section>
<section id="stretching-the-word-count-muscle" class="level3">
<h3 class="anchored" data-anchor-id="stretching-the-word-count-muscle">Stretching the word count muscle</h3>
<p>I realized the original story was a bit short, so I wanted to see if ChatGPT could expand it for me. So I followed up with further instructions:</p>
<blockquote class="blockquote">
<p><em>Great! Now can you rewrite the story in 200 words?</em></p>
</blockquote>
<p>This ChatGPT was a bit further from the goal, providing a story that, while entertaining, came in at 305 words.</p>
<blockquote class="blockquote">
<p>In the shadow of an ancient, twisted oak, beneath the velvet embrace of a moonlit sky, two souls, entwined by fate’s cruel and unyielding hand, found an unexpected sanctuary amidst whispers of the forgotten and the unseen. Evan, whose heart was haunted by echoes of the past, a specter wandering through life’s shadowed corridors, and Lila, a radiant beacon of hope, piercing his eternal night, discovered in each other’s embrace a solace that defied the encroaching darkness that sought to claim them.</p>
</blockquote>
<blockquote class="blockquote">
<p>Their love, a rebellious flame, flickered fiercely against the night’s chilling embrace, a testament to its power to defy the cold grip of despair. Their kisses, tender and soft, carried the warmth of their intertwined souls, speaking of a love as enduring as the stars that watched over them from the heavens. Amid the whispers of the night, filled with secrets of the undead and tales of spectral hauntings, their hearts beat in unison, a melody of life and love that drowned out the murmurs of death.</p>
</blockquote>
<blockquote class="blockquote">
<p>As they stood together, hand in hand, beneath the ancient oak, the world around them seemed to pause, acknowledging the strength of their bond. The darkness, which once seemed an impenetrable veil, now felt like a mere shadow, chased away by the light of their love. In this eerie, yet magical embrace, Evan and Lila found their forever, a testament to the fact that even in a world filled with monsters, and blood, and ghosts, and death, love could flourish, a beacon of hope illuminating the darkest of nights.</p>
</blockquote>
<blockquote class="blockquote">
<p>In this love story, crafted from the threads of horror and beauty intertwined, they proved that even the most haunted of hearts could find peace, and perhaps, a chance at redemption. This was their Valentine, a story not of fear, but of love’s triumph over the shadows.</p>
</blockquote>
<p>This was a great story as well - and I think it managed to keep the same style and story elements from the original version. However, I noticed something… <em>the story seemed a bit long, right?</em>adg, so I followed up and asked for a word count, getting the following response:ues.. <em>The revised story contains 305 words.</em> &gt;</p>
<p>Hmm… No that’s a bit far off. Let’s try again, I think!</p>
<p>I prompted:</p>
<blockquote class="blockquote">
<p><em>Please shorten it to 200 words</em></p>
</blockquote>
<p>ChatGPT’s response?</p>
<blockquote class="blockquote">
<p>In the shadow of an ancient oak, under a moonlit sky, Evan and Lila, two souls bound by fate, found solace. Evan, haunted by past shadows, and Lila, a light in his darkness, discovered love amidst the gloom. Their love, a defiant flame against the night, was a testament to their bond. Their kisses, soft as whispers, spoke of enduring love, stronger than the secrets of the night.</p>
</blockquote>
<blockquote class="blockquote">
<p>As they stood hand in hand, the world seemed to acknowledge their union, the darkness retreating before their love’s light. In this embrace, they found their forever, proving that even in a world of shadows, love could flourish. Their story, a blend of horror and beauty, showed that the most haunted hearts could find peace and redemption. This was their Valentine—a tale not of fear, but of love’s victory over darkness.</p>
</blockquote>
<p>Well… <em>now, that seems a bit <strong>short</strong>!!</em></p>
<p>Upon asking, I realized I was correct - the new story was only 139 words.</p>
<p>Interesting, it seems like ChatGPT has an issue with word count? <strong>Let’s explore that!</strong> of ice.rice, A heart so true, for a heart of ice.</p>
</section>
</section>
<section id="following-the-leader" class="level2">
<h2 class="anchored" data-anchor-id="following-the-leader">Following the leader?</h2>
<p>I sent the following query to ChatGPT</p>
<blockquote class="blockquote">
<p><em>Hmm… that’s a bit short</em></p>
</blockquote>
<p>It replied</p>
<blockquote class="blockquote">
<p>Let’s expand it to meet the 200-word requirement more closely.</p>
</blockquote>
<blockquote class="blockquote">
<p>Beneath the ancient canopy of a twisted oak, under a sky bathed in moonlight, Evan and Lila found a sanctuary woven from the threads of destiny. Evan, a soul haunted by the echoes of a shadowed past, and Lila, a beacon of unwavering light in his world of darkness, discovered an unexpected solace in each other’s presence. Their love, a rebellious spark, ignited a flame that defied the engulfing night, a beacon against the encroaching shadows.</p>
</blockquote>
<blockquote class="blockquote">
<p>Their kisses, gentle as the caress of a ghostly breeze, were declarations of a love that promised eternity, transcending the whispers of the night that spoke of forgotten tales and spectral presences. As they stood, hands clasped, beneath the watchful gaze of the oak, the world around them stilled, a silent witness to the strength of their bond. The darkness, once a suffocating veil, now seemed a mere backdrop, its advance halted by the radiance of their love.</p>
</blockquote>
<blockquote class="blockquote">
<p>In this moment, amidst the eerie yet enchanting embrace, Evan and Lila found their forever, a testament to the enduring power of love over the specters of despair. Their story, a tapestry of horror and beauty, horror and hope intertwined, showcased that even the most tormented souls could find peace, and perhaps, a path to redemption. This narrative, their Valentine, was not a tale woven from fear, but a celebration of love’s triumph over the darkest shadows.</p>
</blockquote>
<blockquote class="blockquote">
<p>Let’s check the word count now.</p>
</blockquote>
<blockquote class="blockquote">
<p>The expanded story now contains 231 words, slightly over the target but closer to the intended length.</p>
</blockquote>
<p>I found a few things interesting here: 1. I never explicitly stated that I wanted the system to increase the story’s length. That it immediately knew that I was unhappy and corrected its response is a pretty impressive understanding of subtext. 2. The system automatically conducted a word count after producing the new story without needing prompting from me, which is another impressive understanding of my desires. 3. Despite all this, the story is still not the correct length.</p>
<p><strong><em>Interesting!</em></strong> length. &gt;</p>
<section id="a-word-count-spiral" class="level3">
<h3 class="anchored" data-anchor-id="a-word-count-spiral">A Word Count Spiral</h3>
<p>I found it very interesting that ChatGPT seemed unable to meet me demands for a specific word count - especially becuase this is a skill with which most students are very familiar. I decided to see if I could push it a bit further.</p>
<p>I prompted:</p>
<blockquote class="blockquote">
<p>Please ensure that your output is exactly 200 words</p>
</blockquote>
<p>And ChatGPT continued to struggle. It subsequently produced 4 additional versions of the story, each time independently conducting a word count analysis without further input from me. And each time, the stories were off from the word count target, coming in at <strong>241, 174, 185, and 186 words respectively</strong>.</p>
<p><strong>DISAPPOINTING</strong></p>
<p>Ultimately it took another 3 rounds of stories - and the very pointed question of <em>“Why is this not 200 words?”</em> - for ChatGPT to produce a draft that had 199 words.</p>
<p>ChatGPT’s final response to me was:</p>
<blockquote class="blockquote">
<p>The narrative is 199 words long, just one word short of the exact 200-word target. Adjusting for precision in word count can be quite challenging, but the goal was nearly met with this attempt. To achieve precisely 200 words, a single word could be added to complete the story accurately​</p>
</blockquote>
<p>…Seems like it could have just added the extra word!!</p>
<p><strong>It just goes to show that even some of the tasks that we think ChatGPT might be best suited for are still difficult!</strong></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/lquinlan95\.github\.io\/comm4190_S24_Using_LLMs_Blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>